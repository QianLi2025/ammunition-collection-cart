#include "BSP_CAN.h"
#include "can.h"
#include <stdint.h>
#include "M3508.h"

extern DJI_Motor_Measure_s M3508,M3508_lf, M3508_lb, M3508_rf, M3508_rb;
/**
 * @brief ??CAN??????
 * 
 * ???????CAN??,???HAL????????
 * ?????????CAN instance????tx_buff,?????????????????
 * ???????????tx_buff,????????
 * 
 * @param m1 ?????????,int16_t??
 * @param m2 ?????????,int1_t??
 * @param m3 ?????????,int16_t??
 * @param m4 ?????????,int16_t??
 */
/**
 * CAN_Transmit_lower??????CAN????????
 * ???????int16_t?????,?????????
 * ???????????CAN???,???CAN??????
 * 
 * @param m1 ?????????,???int16_t
 * @param m2 ?????????,???int16_t
 * @param m3 ?????????,???int16_t
 * @param m4 ?????????,???int16_t
 */
void CAN_Transmit_lower(int16_t m1,int16_t m2,int16_t m3,int16_t m4){
    // ???CAN?????
    CAN_TxHeaderTypeDef Tx_header;
    Tx_header.DLC = 8; // ?????,?????????8??
    Tx_header.ExtId = 0; // ?????,?????0,????????
    Tx_header.IDE = CAN_ID_STD; // ???????,?????????
    Tx_header.RTR = CAN_RTR_DATA; // ????,?????????
    Tx_header.StdId = 0x200; // ?????,?????0x200

    // ???????????,???8??
    uint8_t tx_data[8];

    // ?int16_t??????????uint8_t?????,???CAN?????????
    tx_data[0]=m1>>8;
    tx_data[1]=m1&0xff;
    tx_data[2]=m2>>8;
    tx_data[3]=m2&0xff;
    tx_data[4]=m3>>8;
    tx_data[5]=m3&0xff;
    tx_data[6]=m4>>8;
    tx_data[7]=m4&0xff;

    // ?????????????
    uint32_t tx_mailbox;
		HAL_CAN_AddTxMessage(&hcan1,&Tx_header,tx_data,&tx_mailbox);
		
}

/**
 * CAN_Transmit_upper??????CAN????????
 * ???????int16_t?????,?????????
 * ???????????CAN???,???CAN??????
 * 
 * @param m1 ?????????,???int16_t
 * @param m2 ?????????,???int16_t
 * @param m3 ?????????,???int16_t
 * @param m4 ?????????,???int16_t
 */
//void CAN_Transmit_upper(int16_t m1,int16_t m2,int16_t m3,int16_t m4){
//    // ???CAN?????
//    CAN_TxHeaderTypeDef Tx_header;
//    Tx_header.DLC = 8; // ?????,?????????8??
//    Tx_header.ExtId = 0; // ?????,?????0,????????
//    Tx_header.IDE = CAN_ID_STD; // ???????,?????????
//    Tx_header.RTR = CAN_RTR_DATA; // ????,?????????
//    Tx_header.StdId = 0x1FF; // ?????,?????0x1FF

//    // ???????????,???8??
//    uint8_t tx_data[8];

//    // ?int16_t??????????uint8_t?????,???CAN?????????
//    tx_data[0]=m1>>8;
//    tx_data[1]=m1&0xff;
//    tx_data[2]=m2>>8;
//    tx_data[3]=m2&0xff;
//    tx_data[4]=m3>>8;
//    tx_data[5]=m3&0xff;
//    tx_data[6]=m4>>8;
//    tx_data[7]=m4&0xff;

//    // ?????????????
//    uint32_t tx_mailbox;

//    // ??HAL???,?????CAN??????????
//    HAL_CAN_AddTxMessage(&hcan1,&Tx_header,tx_data,&tx_mailbox);
//}
/**
 * @brief ??CAN?????
 * 
 * ???????CAN????????CAN??????????
 * ???????????????????????????????ID???
 * 
 * @param _instance CAN????,????????????CAN??
 */
void CANAddFilter()
{
    // ????CAN????????
    CAN_FilterTypeDef sFilterConfig;
    
    // ???????????????,?????,???????????????????????
    sFilterConfig.FilterMode = CAN_FILTERMODE_IDMASK;
    
    // ????????16?,?????????16?,??????
    sFilterConfig.FilterScale = CAN_FILTERSCALE_16BIT;
    
    // ??????????14????????, SlaveStartFilterBank????CAN FD???,?????????????
    sFilterConfig.SlaveStartFilterBank = 14;
    
    // ???????????0????
    sFilterConfig.FilterBank = 0;
    
    // ?????FIFO0??,????????????????FIFO0?
    sFilterConfig.FilterFIFOAssignment = CAN_FILTER_FIFO0;
    
    // ??????ID???16?,??????0,?????????
    sFilterConfig.FilterMaskIdHigh = 0x0000;
    
    // ??????ID???16?,??????0,??16????????ID??
    sFilterConfig.FilterMaskIdLow = 0x0000;
    
    // ?????,??????
    sFilterConfig.FilterActivation = CAN_FILTER_ENABLE;

    // ??HAL???,?????????CAN???
    HAL_CAN_ConfigFilter(&hcan1, &sFilterConfig);
}
/**
 * @brief ????CAN????????????????,??CAN??
 *
 * @note ??????CAN1?CAN2,??CAN1?CAN2?FIFO0 & FIFO1????
 *
 */
/**
 * @brief CAN??FIFO????
 * 
 * ???????CAN??FIFO?????????????????,
 * ????fifox????????FIFO?????
 * 
 * @param _hcan ??CAN?????
 * @param fifox ????FIFO???,???CAN_RX_FIFO0?CAN_RX_FIFO1
 */
void CANFIFOxCallback(CAN_HandleTypeDef *_hcan, uint32_t fifox)
{
    CAN_RxHeaderTypeDef rx_header; // ????????CAN???????
    uint8_t rx_data[8]; // ????????CAN????????
    while (HAL_CAN_GetRxFifoFillLevel(&hcan1, CAN_RX_FIFO0)) // ??FIFO????,??????????
    {
        HAL_CAN_GetRxMessage(&hcan1, CAN_RX_FIFO0, &rx_header, rx_data); // ?FIFO?????
        if(rx_header.StdId==0x201)DecodeDJIMotor(rx_data,&M3508_lf);
        else if(rx_header.StdId==0x202)DecodeDJIMotor(rx_data,&M3508_rf);
        else if(rx_header.StdId==0x203)DecodeDJIMotor(rx_data,&M3508_rb);
        else if(rx_header.StdId==0x204)DecodeDJIMotor(rx_data,&M3508_lb);
        else if(rx_header.StdId==0x208)DecodeDJIMotor(rx_data,&M3508);
    }
}

/**
 * @brief ??,STM32???CAN??????FIFO
 * ???????HAL???????,???HAL???__weak,?????????(??)
 * ?FIFO0?FIFO1???????????
 */
// ????????CANFIFOxCallback()??????????CAN?????

/**
 * @brief rx fifo callback. Once FIFO_0 is full,this func would be called
 *
 * @param hcan CAN handle indicate which device the oddest mesg in FIFO_0 comes from
 */
void HAL_CAN_RxFifo0MsgPendingCallback(CAN_HandleTypeDef *hcan)
{
    CANFIFOxCallback(hcan, CAN_RX_FIFO0); // ???????????????
}

/**
 * @brief rx fifo callback. Once FIFO_1 is full,this func would be called
 *
 * @param hcan CAN handle indicate which device the oddest mesg in FIFO_1 comes from
 */